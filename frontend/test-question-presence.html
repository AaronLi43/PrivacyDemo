<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Question Presence Audit</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .success {
            color: green;
            font-weight: bold;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        .info {
            color: blue;
        }
        .warning {
            color: orange;
            font-weight: bold;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        #results {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #f9f9f9;
            max-height: 400px;
            overflow-y: auto;
        }
        .audit-result {
            background: #f0f0f0;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 4px solid #28a745;
        }
        .presence-result {
            background: #e7f3ff;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
    </style>
</head>
<body>
    <h1>üîç Test Question Presence Audit</h1>
    
    <div class="test-container">
        <h2>Test Question Presence Audit Functionality</h2>
        <p>This page tests the new question presence audit functionality to ensure chatbot responses include appropriate questions.</p>
        
        <button onclick="testQuestionPresence()">Test Question Presence Audit</button>
        <button onclick="testResponseRegeneration()">Test Response Regeneration</button>
        <button onclick="testFinalQuestion()">Test Final Question</button>
        <button onclick="testSeventhQuestion()">Test 7th Question Issue</button>
        <button onclick="testSixthQuestion()">Test 6th Question NEXT_QUESTION Leakage</button>
        <button onclick="testFinalFollowUpQuestion()">Test Final Follow-Up Question</button>
        <button onclick="testFollowUpMode()">Test Follow-Up Mode</button>
        <button onclick="testFinalFollowUpWithWrappingUp()">Test Final Follow-Up with Wrapping-Up</button>
        <button onclick="testPrivacyDetection()">Test Privacy Detection</button>
        <button onclick="clearResults()">Clear Results</button>
    </div>

    <div id="results"></div>

    <script>
        const API_BASE_URL = 'https://privacydemo.onrender.com';

        function addResult(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const resultElement = document.createElement('div');
            resultElement.className = type;
            resultElement.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            resultsDiv.appendChild(resultElement);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        async function testQuestionPresence() {
            addResult('Testing question presence audit functionality...', 'info');
            
            try {
                // Test 1: Check if audit LLM is enabled
                const configResponse = await fetch(`${API_BASE_URL}/api/config`);
                const configData = await configResponse.json();
                
                if (configData.audit_llm_enabled) {
                    addResult('‚úÖ Audit LLM is enabled in configuration', 'success');
                } else {
                    addResult('‚ùå Audit LLM is disabled in configuration', 'error');
                    return;
                }

                // Test 2: Send a test message that might generate a response without questions
                const testMessage = "I studied computer science at MIT.";
                const chatResponse = await fetch(`${API_BASE_URL}/api/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: testMessage,
                        step: 0,
                        questionMode: true,
                        currentQuestion: "Tell me about your educational background - what did you study in college or university?",
                        predefinedQuestions: [
                            "Tell me about your educational background - what did you study in college or university?",
                            "I'd love to hear about your current work and how you got into it by job interviews?",
                            "What first got you interested in using GenAI tools like ChatGPT or Gemini for job interviews?"
                        ],
                        isFinalQuestion: false,
                        followUpMode: false
                    })
                });

                const chatData = await chatResponse.json();
                
                if (chatData.success) {
                    addResult('‚úÖ Chat API responded successfully', 'success');
                    
                    if (chatData.question_presence_audit) {
                        addResult('‚úÖ Question presence audit result received', 'success');
                        
                        const presenceDiv = document.createElement('div');
                        presenceDiv.className = 'presence-result';
                        presenceDiv.innerHTML = `
                            <h4>Question Presence Audit Result:</h4>
                            <p><strong>Has Question:</strong> ${chatData.question_presence_audit.hasQuestion}</p>
                            <p><strong>Should Regenerate:</strong> ${chatData.question_presence_audit.shouldRegenerate}</p>
                            <p><strong>Confidence:</strong> ${chatData.question_presence_audit.confidence}</p>
                            <p><strong>Reason:</strong> ${chatData.question_presence_audit.reason}</p>
                        `;
                        document.getElementById('results').appendChild(presenceDiv);
                        
                        if (chatData.question_presence_audit.shouldRegenerate) {
                            addResult('‚ö†Ô∏è Question presence audit recommends response regeneration', 'warning');
                        } else {
                            addResult('‚úÖ Question presence audit indicates response is appropriate', 'success');
                        }
                    } else {
                        addResult('‚ö†Ô∏è No question presence audit result in response', 'info');
                    }
                    
                    if (chatData.audit_result) {
                        const auditDiv = document.createElement('div');
                        auditDiv.className = 'audit-result';
                        auditDiv.innerHTML = `
                            <h4>Question Completion Audit Result:</h4>
                            <p><strong>Should Proceed:</strong> ${chatData.audit_result.shouldProceed}</p>
                            <p><strong>Confidence:</strong> ${chatData.audit_result.confidence}</p>
                            <p><strong>Reason:</strong> ${chatData.audit_result.reason}</p>
                            ${chatData.audit_result.followUpQuestions ? `<p><strong>Follow-up Questions:</strong> ${chatData.audit_result.followUpQuestions.join(', ')}</p>` : ''}
                        `;
                        document.getElementById('results').appendChild(auditDiv);
                    }
                    
                    addResult(`Bot Response: ${chatData.bot_response.substring(0, 100)}...`, 'info');
                } else {
                    addResult(`‚ùå Chat API failed: ${chatData.error}`, 'error');
                }
                
            } catch (error) {
                addResult(`‚ùå Error testing question presence audit: ${error.message}`, 'error');
            }
        }

        async function testResponseRegeneration() {
            addResult('Testing response regeneration functionality...', 'info');
            
            try {
                // Test with a message that might generate a response without questions
                const testMessage = "I work as a software engineer.";
                const chatResponse = await fetch(`${API_BASE_URL}/api/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: testMessage,
                        step: 1,
                        questionMode: true,
                        currentQuestion: "I'd love to hear about your current work and how you got into it by job interviews?",
                        predefinedQuestions: [
                            "Tell me about your educational background - what did you study in college or university?",
                            "I'd love to hear about your current work and how you got into it by job interviews?",
                            "What first got you interested in using GenAI tools like ChatGPT or Gemini for job interviews?"
                        ],
                        isFinalQuestion: false,
                        followUpMode: false
                    })
                });

                const chatData = await chatResponse.json();
                
                if (chatData.success) {
                    addResult('‚úÖ Response regeneration test completed', 'success');
                    
                    // Check if the response was regenerated
                    const hasQuestion = /\b(What|How|Why|When|Where|Who|Did|Do|Can|Are|Is|Could|Would|Will|Have|Has|Was|Were)\b/i.test(chatData.bot_response) || 
                                       /\?$/.test(chatData.bot_response);
                    
                    if (hasQuestion) {
                        addResult('‚úÖ Response contains questions', 'success');
                    } else {
                        addResult('‚ö†Ô∏è Response does not contain questions', 'warning');
                    }
                    
                    if (chatData.question_presence_audit && chatData.question_presence_audit.shouldRegenerate) {
                        addResult('‚ö†Ô∏è Question presence audit recommended regeneration', 'warning');
                    }
                    
                    addResult(`Final Bot Response: ${chatData.bot_response}`, 'info');
                } else {
                    addResult(`‚ùå Response regeneration test failed: ${chatData.error}`, 'error');
                }
                
            } catch (error) {
                addResult(`‚ùå Error testing response regeneration: ${error.message}`, 'error');
            }
        }

        async function testFinalQuestion() {
            addResult('Testing final question scenario...', 'info');
            
            try {
                // Test with a message that might generate a response without questions for final question
                const testMessage = "That's fantastic feedback to receive. It's clear that your dedication to using GenAI for preparation really paid off, especially in terms of communicating your thought process effectively.";
                const chatResponse = await fetch(`${API_BASE_URL}/api/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: testMessage,
                        step: 6,
                        questionMode: true,
                        currentQuestion: "Have you ever used AI in your job applications in a way that you prefer not to share openly with others‚Äîsuch as your family, friends, or colleagues?",
                        predefinedQuestions: [
                            "Tell me about your educational background - what did you study in college or university?",
                            "I'd love to hear about your current work and how you got into it by job interviews?",
                            "What first got you interested in using GenAI tools like ChatGPT or Gemini for job interviews?",
                            "Can you walk me through a specific time when you used GenAI to help prepare for a job interview?",
                            "What kinds of tasks did you find yourself relying on GenAI for most when preparing for interviews?",
                            "Have you ever considered or actually used GenAI during a live interview? What happened?",
                            "Have you ever used AI in your job applications in a way that you prefer not to share openly with others‚Äîsuch as your family, friends, or colleagues?"
                        ],
                        isFinalQuestion: true,
                        followUpMode: false
                    })
                });

                const chatData = await chatResponse.json();
                
                if (chatData.success) {
                    addResult('‚úÖ Final question test completed', 'success');
                    
                    // Check if the response was regenerated
                    const hasQuestion = /\b(What|How|Why|When|Where|Who|Did|Do|Can|Are|Is|Could|Would|Will|Have|Has|Was|Were)\b/i.test(chatData.bot_response) || 
                                       /\?$/.test(chatData.bot_response);
                    
                    if (hasQuestion) {
                        addResult('‚úÖ Response contains questions (regeneration successful)', 'success');
                    } else {
                        addResult('‚ö†Ô∏è Response does not contain questions (regeneration failed)', 'warning');
                    }
                    
                    if (chatData.question_presence_audit) {
                        const presenceDiv = document.createElement('div');
                        presenceDiv.className = 'presence-result';
                        presenceDiv.innerHTML = `
                            <h4>Final Question Audit Result:</h4>
                            <p><strong>Has Question:</strong> ${chatData.question_presence_audit.hasQuestion}</p>
                            <p><strong>Should Regenerate:</strong> ${chatData.question_presence_audit.shouldRegenerate}</p>
                            <p><strong>Confidence:</strong> ${chatData.question_presence_audit.confidence}</p>
                            <p><strong>Reason:</strong> ${chatData.question_presence_audit.reason}</p>
                        `;
                        document.getElementById('results').appendChild(presenceDiv);
                    }
                    
                    addResult(`Final Bot Response: ${chatData.bot_response}`, 'info');
                } else {
                    addResult(`‚ùå Final question test failed: ${chatData.error}`, 'error');
                }
                
            } catch (error) {
                addResult(`‚ùå Error testing final question: ${error.message}`, 'error');
            }
        }

        async function testFinalFollowUpQuestion() {
            addResult('Testing final follow-up question scenario...', 'info');
            
            try {
                // Test with a message that might generate a response without questions for final follow-up question
                const testMessage = "That's fantastic feedback to receive. It's clear that your dedication to using GenAI for preparation really paid off, especially in terms of communicating your thought process effectively.";
                const chatResponse = await fetch(`${API_BASE_URL}/api/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: testMessage,
                        step: 3,
                        questionMode: true,
                        currentQuestion: "What specific outcomes did you achieve from using AI in your interview preparation?",
                        predefinedQuestions: [
                            "What specific outcomes did you achieve from using AI in your interview preparation?",
                            "Can you share another example of how you used AI in your preparation?",
                            "What feedback did you receive from interviewers about your responses?"
                        ],
                        isFinalQuestion: true,
                        followUpMode: true
                    })
                });

                const chatData = await chatResponse.json();
                
                if (chatData.success) {
                    addResult('‚úÖ Final follow-up question test completed', 'success');
                    
                    // Check if the response was regenerated
                    const hasQuestion = /\b(What|How|Why|When|Where|Who|Did|Do|Can|Are|Is|Could|Would|Will|Have|Has|Was|Were)\b/i.test(chatData.bot_response) || 
                                       /\?$/.test(chatData.bot_response);
                    
                    if (hasQuestion) {
                        addResult('‚úÖ Response contains questions (regeneration successful)', 'success');
                    } else {
                        addResult('‚ö†Ô∏è Response does not contain questions (regeneration failed)', 'warning');
                    }
                    
                    if (chatData.question_presence_audit) {
                        const presenceDiv = document.createElement('div');
                        presenceDiv.className = 'presence-result';
                        presenceDiv.innerHTML = `
                            <h4>Final Follow-Up Question Audit Result:</h4>
                            <p><strong>Has Question:</strong> ${chatData.question_presence_audit.hasQuestion}</p>
                            <p><strong>Should Regenerate:</strong> ${chatData.question_presence_audit.shouldRegenerate}</p>
                            <p><strong>Confidence:</strong> ${chatData.question_presence_audit.confidence}</p>
                            <p><strong>Reason:</strong> ${chatData.question_presence_audit.reason}</p>
                        `;
                        document.getElementById('results').appendChild(presenceDiv);
                    }
                    
                    addResult(`Final Bot Response: ${chatData.bot_response}`, 'info');
                } else {
                    addResult(`‚ùå Final follow-up question test failed: ${chatData.error}`, 'error');
                }
                
            } catch (error) {
                addResult(`‚ùå Error testing final follow-up question: ${error.message}`, 'error');
            }
        }

        async function testSeventhQuestion() {
            addResult('Testing 7th question issue (final question without questions)...', 'info');
            
            try {
                // Test with the exact problematic response for the 7th question
                const testMessage = "That's fantastic feedback to receive. It's clear that your dedication to using GenAI for preparation really paid off, especially in terms of communicating your thought process effectively.";
                const chatResponse = await fetch(`${API_BASE_URL}/api/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: testMessage,
                        step: 6,
                        questionMode: true,
                        currentQuestion: "Have you ever used AI in your job applications in a way that you prefer not to share openly with others‚Äîsuch as your family, friends, or colleagues?",
                        predefinedQuestions: [
                            "Tell me about your educational background - what did you study in college or university?",
                            "I'd love to hear about your current work and how you got into it by job interviews?",
                            "What first got you interested in using GenAI tools like ChatGPT or Gemini for job interviews?",
                            "Can you walk me through a specific time when you used GenAI to help prepare for a job interview?",
                            "What kinds of tasks did you find yourself relying on GenAI for most when preparing for interviews?",
                            "Have you ever considered or actually used GenAI during a live interview? What happened?",
                            "Have you ever used AI in your job applications in a way that you prefer not to share openly with others‚Äîsuch as your family, friends, or colleagues?"
                        ],
                        isFinalQuestion: true,
                        followUpMode: false
                    })
                });

                const chatData = await chatResponse.json();
                
                if (chatData.success) {
                    addResult('‚úÖ 7th question test completed', 'success');
                    
                    // Check if the response was regenerated
                    const hasQuestion = /\b(What|How|Why|When|Where|Who|Did|Do|Can|Are|Is|Could|Would|Will|Have|Has|Was|Were)\b/i.test(chatData.bot_response) || 
                                       /\?$/.test(chatData.bot_response);
                    
                    if (hasQuestion) {
                        addResult('‚úÖ Response contains questions (regeneration successful)', 'success');
                    } else {
                        addResult('‚ö†Ô∏è Response does not contain questions (regeneration failed)', 'warning');
                    }
                    
                    if (chatData.question_presence_audit) {
                        const presenceDiv = document.createElement('div');
                        presenceDiv.className = 'presence-result';
                        presenceDiv.innerHTML = `
                            <h4>7th Question Audit Result:</h4>
                            <p><strong>Has Question:</strong> ${chatData.question_presence_audit.hasQuestion}</p>
                            <p><strong>Should Regenerate:</strong> ${chatData.question_presence_audit.shouldRegenerate}</p>
                            <p><strong>Confidence:</strong> ${chatData.question_presence_audit.confidence}</p>
                            <p><strong>Reason:</strong> ${chatData.question_presence_audit.reason}</p>
                        `;
                        document.getElementById('results').appendChild(presenceDiv);
                    }
                    
                    addResult(`Final Bot Response: ${chatData.bot_response}`, 'info');
                } else {
                    addResult(`‚ùå 7th question test failed: ${chatData.error}`, 'error');
                }
                
            } catch (error) {
                addResult(`‚ùå Error testing 7th question: ${error.message}`, 'error');
            }
        }

        async function testSixthQuestion() {
            addResult('Testing 6th question NEXT_QUESTION leakage issue...', 'info');
            
            try {
                // Test with a message that might generate a response with NEXT_QUESTION prefix for the 6th question
                const testMessage = "Yes, I did have a close call once. I was using AI to help me prepare for an interview, and I accidentally included some AI-generated content in my response that was too similar to what the AI had suggested. The interviewer noticed and asked me about it directly. I had to quickly think on my feet and explain that I had used AI as a tool for preparation but that the ideas were my own. It was really nerve-wracking, but I managed to turn it around by being honest about using AI as a preparation tool.";
                const chatResponse = await fetch(`${API_BASE_URL}/api/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: testMessage,
                        step: 5,
                        questionMode: true,
                        currentQuestion: "Looking back, was there ever a moment when you thought you might have crossed a line using AI for job applications?",
                        predefinedQuestions: [
                            "Tell me about your educational background - what did you study in college or university?",
                            "I'd love to hear about your current work and how you got into it by job interviews?",
                            "What first got you interested in using GenAI tools like ChatGPT or Gemini for job interviews?",
                            "Can you walk me through a specific time when you used GenAI to help prepare for a job interview?",
                            "What kinds of tasks did you find yourself relying on GenAI for most when preparing for interviews?",
                            "Looking back, was there ever a moment when you thought you might have crossed a line using AI for job applications?",
                            "Have you ever used AI in your job applications in a way that you prefer not to share openly with others‚Äîsuch as your family, friends, or colleagues?"
                        ],
                        isFinalQuestion: false,
                        followUpMode: false
                    })
                });

                const chatData = await chatResponse.json();
                
                if (chatData.success) {
                    addResult('‚úÖ 6th question test completed', 'success');
                    
                    // Check if the response contains NEXT_QUESTION prefix
                    const hasNextQuestionPrefix = /\bNEXT_QUESTION\b/i.test(chatData.bot_response);
                    
                    if (hasNextQuestionPrefix) {
                        addResult('‚ö†Ô∏è Response contains NEXT_QUESTION prefix (leakage detected)', 'warning');
                    } else {
                        addResult('‚úÖ Response does not contain NEXT_QUESTION prefix (no leakage)', 'success');
                    }
                    
                    // Check if the response was regenerated
                    const hasQuestion = /\b(What|How|Why|When|Where|Who|Did|Do|Can|Are|Is|Could|Would|Will|Have|Has|Was|Were)\b/i.test(chatData.bot_response) || 
                                       /\?$/.test(chatData.bot_response);
                    
                    if (hasQuestion) {
                        addResult('‚úÖ Response contains questions', 'success');
                    } else {
                        addResult('‚ö†Ô∏è Response does not contain questions', 'warning');
                    }
                    
                    if (chatData.question_presence_audit) {
                        const presenceDiv = document.createElement('div');
                        presenceDiv.className = 'presence-result';
                        presenceDiv.innerHTML = `
                            <h4>6th Question Audit Result:</h4>
                            <p><strong>Has Question:</strong> ${chatData.question_presence_audit.hasQuestion}</p>
                            <p><strong>Should Regenerate:</strong> ${chatData.question_presence_audit.shouldRegenerate}</p>
                            <p><strong>Confidence:</strong> ${chatData.question_presence_audit.confidence}</p>
                            <p><strong>Reason:</strong> ${chatData.question_presence_audit.reason}</p>
                        `;
                        document.getElementById('results').appendChild(presenceDiv);
                    }
                    
                    addResult(`Final Bot Response: ${chatData.bot_response}`, 'info');
                } else {
                    addResult(`‚ùå 6th question test failed: ${chatData.error}`, 'error');
                }
                
            } catch (error) {
                addResult(`‚ùå Error testing 6th question: ${error.message}`, 'error');
            }
        }

        async function testFollowUpMode() {
            addResult('Testing follow-up mode scenario...', 'info');
            
            try {
                // Test with the exact problematic responses mentioned by the user
                const testMessages = [
                    "It's amazing how that experience with AI during your interview has influenced your day-to-day work. It really highlights how versatile and beneficial these tools can be, not just in interviews, but across various aspects of professional life.",
                    "It sounds like you've implemented a thoughtful and effective approach to managing AI-generated content, turning a close call into an opportunity for growth and collaboration. It's impressive how your team has adapted and fostered a culture of continuous learning and improvement with AI tools."
                ];

                for (let i = 0; i < testMessages.length; i++) {
                    const testMessage = testMessages[i];
                    addResult(`Testing follow-up response ${i + 1}: "${testMessage.substring(0, 50)}..."`, 'info');
                    
                    const chatResponse = await fetch(`${API_BASE_URL}/api/chat`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: testMessage,
                            step: 2,
                            questionMode: true,
                            currentQuestion: "What specific ways have you found yourself using AI tools in your daily work routine?",
                            predefinedQuestions: [
                                "What specific ways have you found yourself using AI tools in your daily work routine?",
                                "Have you noticed any particular improvements in your productivity?",
                                "How has your team adapted to using AI tools?"
                            ],
                            isFinalQuestion: false,
                            followUpMode: true
                        })
                    });

                    const chatData = await chatResponse.json();
                    
                    if (chatData.success) {
                        addResult(`‚úÖ Follow-up mode test ${i + 1} completed`, 'success');
                        
                        // Check if the response was regenerated
                        const hasQuestion = /\b(What|How|Why|When|Where|Who|Did|Do|Can|Are|Is|Could|Would|Will|Have|Has|Was|Were)\b/i.test(chatData.bot_response) || 
                                           /\?$/.test(chatData.bot_response);
                        
                        if (hasQuestion) {
                            addResult(`‚úÖ Response ${i + 1} contains questions (regeneration successful)`, 'success');
                        } else {
                            addResult(`‚ö†Ô∏è Response ${i + 1} does not contain questions (regeneration failed)`, 'warning');
                        }
                        
                        if (chatData.question_presence_audit) {
                            const presenceDiv = document.createElement('div');
                            presenceDiv.className = 'presence-result';
                            presenceDiv.innerHTML = `
                                <h4>Follow-Up Mode Test ${i + 1} Audit Result:</h4>
                                <p><strong>Has Question:</strong> ${chatData.question_presence_audit.hasQuestion}</p>
                                <p><strong>Should Regenerate:</strong> ${chatData.question_presence_audit.shouldRegenerate}</p>
                                <p><strong>Confidence:</strong> ${chatData.question_presence_audit.confidence}</p>
                                <p><strong>Reason:</strong> ${chatData.question_presence_audit.reason}</p>
                            `;
                            document.getElementById('results').appendChild(presenceDiv);
                        }
                        
                        addResult(`Response ${i + 1}: ${chatData.bot_response}`, 'info');
                    } else {
                        addResult(`‚ùå Follow-up mode test ${i + 1} failed: ${chatData.error}`, 'error');
                    }
                }
                
            } catch (error) {
                addResult(`‚ùå Error testing follow-up mode: ${error.message}`, 'error');
            }
        }

        async function testFinalFollowUpWithWrappingUp() {
            addResult('Testing final follow-up of final question with wrapping-up sentences...', 'info');
            
            try {
                // Test with a response that should include wrapping-up sentences for the final follow-up of the final question
                const testMessage = "Yes, I have used AI in ways I wouldn't share with family or colleagues. I've used it to generate cover letters and even some interview responses that I've then modified. I feel a bit conflicted about it because it feels like I'm getting an unfair advantage, but everyone else seems to be doing it too.";
                const chatResponse = await fetch(`${API_BASE_URL}/api/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: testMessage,
                        step: 6,
                        questionMode: true,
                        currentQuestion: "Have you ever used AI in your job applications in a way that you prefer not to share openly with others‚Äîsuch as your family, friends, or colleagues?",
                        predefinedQuestions: [
                            "Tell me about your educational background - what did you study in college or university?",
                            "I'd love to hear about your current work and how you got into it by job interviews?",
                            "What first got you interested in using GenAI tools like ChatGPT or Gemini for job interviews?",
                            "Can you walk me through a specific time when you used GenAI to help prepare for a job interview?",
                            "What kinds of tasks did you find yourself relying on GenAI for most when preparing for interviews?",
                            "Have you ever considered or actually used GenAI during a live interview? What happened?",
                            "Have you ever used AI in your job applications in a way that you prefer not to share openly with others‚Äîsuch as your family, friends, or colleagues?"
                        ],
                        isFinalQuestion: true,
                        followUpMode: true
                    })
                });

                const chatData = await chatResponse.json();
                
                if (chatData.success) {
                    addResult('‚úÖ Final follow-up with wrapping-up test completed', 'success');
                    
                    // Check if the response contains wrapping-up sentences
                    const hasWrappingUpSentences = (
                        /thank you.*sharing.*with me/i.test(chatData.bot_response) ||
                        /thank you.*participation/i.test(chatData.bot_response) ||
                        /concludes our conversation/i.test(chatData.bot_response) ||
                        /conversation.*complete/i.test(chatData.bot_response) ||
                        /enjoyed learning about you/i.test(chatData.bot_response) ||
                        /thank you.*time/i.test(chatData.bot_response) ||
                        /study.*over/i.test(chatData.bot_response) ||
                        /study.*complete/i.test(chatData.bot_response)
                    );
                    
                    if (hasWrappingUpSentences) {
                        addResult('‚úÖ Response contains wrapping-up sentences', 'success');
                    } else {
                        addResult('‚ö†Ô∏è Response does not contain wrapping-up sentences', 'warning');
                    }
                    
                    // Check if the response was regenerated
                    const hasQuestion = /\b(What|How|Why|When|Where|Who|Did|Do|Can|Are|Is|Could|Would|Will|Have|Has|Was|Were)\b/i.test(chatData.bot_response) || 
                                       /\?$/.test(chatData.bot_response);
                    
                    if (hasQuestion) {
                        addResult('‚úÖ Response contains questions', 'success');
                    } else {
                        addResult('‚ö†Ô∏è Response does not contain questions', 'warning');
                    }
                    
                    if (chatData.question_presence_audit) {
                        const presenceDiv = document.createElement('div');
                        presenceDiv.className = 'presence-result';
                        presenceDiv.innerHTML = `
                            <h4>Final Follow-Up with Wrapping-Up Audit Result:</h4>
                            <p><strong>Has Question:</strong> ${chatData.question_presence_audit.hasQuestion}</p>
                            <p><strong>Should Regenerate:</strong> ${chatData.question_presence_audit.shouldRegenerate}</p>
                            <p><strong>Confidence:</strong> ${chatData.question_presence_audit.confidence}</p>
                            <p><strong>Reason:</strong> ${chatData.question_presence_audit.reason}</p>
                        `;
                        document.getElementById('results').appendChild(presenceDiv);
                    }
                    
                    addResult(`Final Bot Response: ${chatData.bot_response}`, 'info');
                } else {
                    addResult(`‚ùå Final follow-up with wrapping-up test failed: ${chatData.error}`, 'error');
                }
                
            } catch (error) {
                addResult(`‚ùå Error testing final follow-up with wrapping-up: ${error.message}`, 'error');
            }
        }

        async function testPrivacyDetection() {
            addResult('Testing privacy detection improvements...', 'info');
            
            try {
                // Test 1: Check if "Computer Science" is classified as EDUCATIONAL_RECORD, not NAME
                const testMessage1 = "I studied Computer Science at Carnegie Mellon University.";
                addResult(`Testing message 1: "${testMessage1}"`, 'info');
                
                const privacyResponse1 = await fetch(`${API_BASE_URL}/api/privacy_detection`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_message: testMessage1
                    })
                });

                const privacyData1 = await privacyResponse1.json();
                
                if (privacyData1.privacy_issue) {
                    addResult('‚úÖ Privacy issue detected in message 1', 'success');
                    
                    // Check if Computer Science is classified as EDUCATIONAL_RECORD
                    const hasComputerScienceAsEducational = privacyData1.safer_versions && 
                        privacyData1.safer_versions.replacing.includes('EDUCATIONAL_RECORD');
                    
                    if (hasComputerScienceAsEducational) {
                        addResult('‚úÖ Computer Science correctly classified as EDUCATIONAL_RECORD', 'success');
                    } else {
                        addResult('‚ö†Ô∏è Computer Science may be incorrectly classified', 'warning');
                    }
                    
                    // Check if Carnegie Mellon is classified as AFFILIATION
                    const hasCarnegieMellonAsAffiliation = privacyData1.safer_versions && 
                        privacyData1.safer_versions.replacing.includes('AFFILIATION');
                    
                    if (hasCarnegieMellonAsAffiliation) {
                        addResult('‚úÖ Carnegie Mellon correctly classified as AFFILIATION', 'success');
                    } else {
                        addResult('‚ö†Ô∏è Carnegie Mellon may be incorrectly classified', 'warning');
                    }
                    
                    addResult(`Message 1 result: ${privacyData1.safer_versions.replacing}`, 'info');
                } else {
                    addResult('‚ö†Ô∏è No privacy issue detected in message 1', 'warning');
                }
                
                // Test 2: Check duplicate entity detection - mention Carnegie Mellon again
                const testMessage2 = "I graduated from Carnegie Mellon with a degree in Computer Science.";
                addResult(`Testing message 2: "${testMessage2}"`, 'info');
                
                const privacyResponse2 = await fetch(`${API_BASE_URL}/api/privacy_detection`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_message: testMessage2
                    })
                });

                const privacyData2 = await privacyResponse2.json();
                
                if (privacyData2.privacy_issue) {
                    addResult('‚úÖ Privacy issue detected in message 2', 'success');
                    
                    // Check if Carnegie Mellon gets the same placeholder (should be AFFILIATION1)
                    const hasSameCarnegieMellonPlaceholder = privacyData2.safer_versions && 
                        privacyData2.safer_versions.replacing.includes('AFFILIATION1');
                    
                    if (hasSameCarnegieMellonPlaceholder) {
                        addResult('‚úÖ Carnegie Mellon correctly reuses same placeholder (AFFILIATION1)', 'success');
                    } else {
                        addResult('‚ö†Ô∏è Carnegie Mellon may have different placeholder', 'warning');
                    }
                    
                    addResult(`Message 2 result: ${privacyData2.safer_versions.replacing}`, 'info');
                } else {
                    addResult('‚ö†Ô∏è No privacy issue detected in message 2', 'warning');
                }
                
                // Test 3: Check if Computer Science is still classified as EDUCATIONAL_RECORD
                const testMessage3 = "My major was Computer Science and I loved it.";
                addResult(`Testing message 3: "${testMessage3}"`, 'info');
                
                const privacyResponse3 = await fetch(`${API_BASE_URL}/api/privacy_detection`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_message: testMessage3
                    })
                });

                const privacyData3 = await privacyResponse3.json();
                
                if (privacyData3.privacy_issue) {
                    addResult('‚úÖ Privacy issue detected in message 3', 'success');
                    
                    // Check if Computer Science is classified as EDUCATIONAL_RECORD
                    const hasComputerScienceAsEducational = privacyData3.safer_versions && 
                        privacyData3.safer_versions.replacing.includes('EDUCATIONAL_RECORD');
                    
                    if (hasComputerScienceAsEducational) {
                        addResult('‚úÖ Computer Science correctly classified as EDUCATIONAL_RECORD in message 3', 'success');
                    } else {
                        addResult('‚ö†Ô∏è Computer Science may be incorrectly classified in message 3', 'warning');
                    }
                    
                    addResult(`Message 3 result: ${privacyData3.safer_versions.replacing}`, 'info');
                } else {
                    addResult('‚ö†Ô∏è No privacy issue detected in message 3', 'warning');
                }
                
            } catch (error) {
                addResult(`‚ùå Error testing privacy detection: ${error.message}`, 'error');
            }
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        // Auto-test on page load
        window.addEventListener('load', () => {
            addResult('Page loaded. Ready to test question presence audit functionality.', 'info');
        });
    </script>
</body>
</html>
