<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Featured Mode Test - Privacy Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-section h3 {
            color: #666;
            margin-bottom: 15px;
        }
        .test-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            margin-bottom: 10px;
        }
        .test-input:focus {
            outline: none;
            border-color: #007bff;
        }
        .privacy-error {
            text-decoration: underline wavy #dc3545;
            background-color: rgba(220, 53, 69, 0.1);
            cursor: pointer;
            position: relative;
            display: inline-block;
            padding: 1px 2px;
            border-radius: 2px;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }
        .privacy-error:hover {
            background-color: rgba(220, 53, 69, 0.2);
            border-color: #dc3545;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(220, 53, 69, 0.2);
        }
        .privacy-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: white;
            border: 2px solid #dc3545;
            border-radius: 8px;
            padding: 15px;
            min-width: 300px;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            margin-bottom: 8px;
        }
        .privacy-tooltip.show {
            opacity: 1;
            visibility: visible;
        }
        .tooltip-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        .tooltip-title {
            font-weight: 600;
            color: #dc3545;
            font-size: 14px;
        }
        .tooltip-severity {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .tooltip-severity.high {
            background-color: rgba(220, 53, 69, 0.2);
            color: #dc3545;
        }
        .tooltip-severity.medium {
            background-color: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }
        .tooltip-severity.low {
            background-color: rgba(23, 162, 184, 0.2);
            color: #17a2b8;
        }
        .tooltip-content {
            margin-bottom: 10px;
        }
        .tooltip-explanation {
            font-size: 13px;
            color: #333;
            margin-bottom: 10px;
            line-height: 1.4;
        }
        .tooltip-suggestion {
            background-color: rgba(40, 167, 69, 0.1);
            border-left: 3px solid #28a745;
            padding: 10px;
            border-radius: 4px;
            font-size: 13px;
            margin-bottom: 10px;
        }
        .tooltip-suggestion strong {
            color: #28a745;
            display: block;
            margin-bottom: 5px;
        }
        .tooltip-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .tooltip-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .tooltip-btn.apply {
            background-color: #28a745;
            color: white;
        }
        .tooltip-btn.apply:hover {
            background-color: #218838;
        }
        .tooltip-btn.close {
            background-color: #6c757d;
            color: white;
        }
        .tooltip-btn.close:hover {
            background-color: #5a6268;
        }
        .examples {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
        }
        .examples h4 {
            margin-bottom: 10px;
            color: #495057;
        }
        .example-item {
            margin-bottom: 8px;
            padding: 8px;
            background: white;
            border-radius: 4px;
            border-left: 3px solid #007bff;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .example-item:hover {
            background-color: #e9ecef;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        .notification.show {
            transform: translateX(0);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîí Featured Mode Test - Real-time Privacy Detection</h1>
        
        <div class="test-section">
            <h3>Real-time Privacy Detection</h3>
            <p>Type sensitive information below to see real-time privacy detection in action:</p>
            <input type="text" id="test-input" class="test-input" placeholder="Try typing: 123-45-6789, john.doe@email.com, (555) 123-4567, 1234-5678-9012-3456">
            
            <div class="examples">
                <h4>Test Examples (click to try):</h4>
                <div class="example-item" onclick="setExample('My SSN is 123-45-6789')">My SSN is 123-45-6789</div>
                <div class="example-item" onclick="setExample('Contact me at john.doe@email.com')">Contact me at john.doe@email.com</div>
                <div class="example-item" onclick="setExample('Call me at (555) 123-4567')">Call me at (555) 123-4567</div>
                <div class="example-item" onclick="setExample('My credit card is 1234-5678-9012-3456')">My credit card is 1234-5678-9012-3456</div>
                <div class="example-item" onclick="setExample('I live at 123 Main Street, Anytown, CA 90210')">I live at 123 Main Street, Anytown, CA 90210</div>
                <div class="example-item" onclick="setExample('My name is John Smith')">My name is John Smith</div>
                <div class="example-item" onclick="setExample('I was born on 12/25/1990')">I was born on 12/25/1990</div>
            </div>
        </div>

        <div class="test-section">
            <h3>How it works:</h3>
            <ul>
                <li><strong>Real-time Detection:</strong> As you type, the system analyzes your text for privacy issues</li>
                <li><strong>Visual Highlighting:</strong> Detected issues are underlined in red with a wavy line</li>
                <li><strong>Interactive Tooltips:</strong> Hover over highlighted text to see detailed information</li>
                <li><strong>One-click Fixes:</strong> Click "Apply Fix" to automatically replace sensitive information</li>
                <li><strong>Smart Suggestions:</strong> Get context-aware suggestions for safer alternatives</li>
            </ul>
        </div>
    </div>

    <!-- Privacy Tooltip -->
    <div id="privacy-tooltip" class="privacy-tooltip">
        <div class="tooltip-header">
            <span class="tooltip-title" id="tooltip-title">Privacy Issue</span>
            <span class="tooltip-severity" id="tooltip-severity">Medium</span>
        </div>
        <div class="tooltip-content">
            <div class="tooltip-explanation" id="tooltip-explanation">
                This text contains potentially sensitive information.
            </div>
            <div class="tooltip-suggestion" id="tooltip-suggestion" style="display: none;">
                <strong>Suggested Fix:</strong>
                <span id="tooltip-suggestion-text"></span>
            </div>
        </div>
        <div class="tooltip-actions">
            <button class="tooltip-btn apply" id="tooltip-apply-btn" style="display: none;">
                Apply Fix
            </button>
            <button class="tooltip-btn close" id="tooltip-close-btn">
                Close
            </button>
        </div>
    </div>

    <script>
        let detectionTimeout;
        let currentPrivacyData = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const testInput = document.getElementById('test-input');
            
            // Real-time detection
            testInput.addEventListener('input', function(e) {
                handleRealTimeDetection(e.target.value);
            });

            // Tooltip events
            document.getElementById('tooltip-close-btn').addEventListener('click', hideTooltip);
            document.getElementById('tooltip-apply-btn').addEventListener('click', applySuggestion);

            // Close tooltip on outside click
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.privacy-tooltip') && !e.target.closest('.privacy-error')) {
                    hideTooltip();
                }
            });
        });

        // Handle real-time privacy detection
        async function handleRealTimeDetection(text) {
            if (!text.trim()) {
                clearDetection();
                return;
            }

            // Debounce the detection
            clearTimeout(detectionTimeout);
            detectionTimeout = setTimeout(async () => {
                await performDetection(text);
            }, 500);
        }

        // Perform privacy detection
        async function performDetection(text) {
            try {
                const response = await fetch('/api/privacy_detection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ user_message: text })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.privacy_issue) {
                        displayPrivacyIssue(text, result);
                    } else {
                        clearDetection();
                    }
                }
            } catch (error) {
                console.error('Detection error:', error);
                // Fallback to client-side detection
                const fallbackResult = detectPrivacyPatterns(text);
                if (fallbackResult.privacy_issue) {
                    displayPrivacyIssue(text, fallbackResult);
                } else {
                    clearDetection();
                }
            }
        }

        // Display privacy issue
        function displayPrivacyIssue(text, privacyResult) {
            const testInput = document.getElementById('test-input');
            currentPrivacyData = privacyResult;

            // Create highlighted version
            const highlightedText = highlightPrivacyIssue(text, privacyResult);
            
            // Create overlay
            const overlay = document.createElement('div');
            overlay.style.position = 'absolute';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.pointerEvents = 'none';
            overlay.style.zIndex = '1';
            overlay.style.backgroundColor = 'transparent';
            overlay.style.border = '2px solid #dc3545';
            overlay.style.borderRadius = '6px';
            overlay.style.padding = '12px';
            overlay.style.fontSize = '16px';
            overlay.style.fontFamily = 'inherit';
            overlay.style.lineHeight = '1.6';
            overlay.style.color = 'transparent';
            overlay.style.caretColor = 'transparent';
            overlay.style.overflow = 'hidden';
            overlay.style.whiteSpace = 'pre-wrap';
            overlay.style.wordWrap = 'break-word';

            overlay.innerHTML = highlightedText;

            // Position overlay
            const inputRect = testInput.getBoundingClientRect();
            overlay.style.position = 'fixed';
            overlay.style.top = `${inputRect.top}px`;
            overlay.style.left = `${inputRect.left}px`;
            overlay.style.width = `${inputRect.width}px`;
            overlay.style.height = `${inputRect.height}px`;

            document.body.appendChild(overlay);
            testInput.overlay = overlay;

            // Add warning
            showWarning(privacyResult);
        }

        // Highlight privacy issue
        function highlightPrivacyIssue(text, privacyResult) {
            if (!privacyResult.affected_text) return text;

            const affectedText = privacyResult.affected_text;
            const severity = privacyResult.severity || 'medium';
            
            const escapedText = escapeHtml(text);
            const escapedAffectedText = escapeHtml(affectedText);
            
            return escapedText.replace(
                new RegExp(escapeRegex(escapedAffectedText), 'gi'),
                `<span class="privacy-error severity-${severity}" data-privacy-type="${privacyResult.type}" data-privacy-severity="${severity}" data-privacy-suggestion="${escapeHtml(privacyResult.suggestion || '')}" data-privacy-explanation="${escapeHtml(privacyResult.explanation || '')}" onmouseenter="showTooltip(this, event)" onmouseleave="hideTooltip()">${escapedAffectedText}</span>`
            );
        }

        // Show warning
        function showWarning(privacyResult) {
            const warning = document.createElement('div');
            warning.id = 'realtime-warning';
            warning.style.position = 'fixed';
            warning.style.top = '20px';
            warning.style.right = '20px';
            warning.style.backgroundColor = '#dc3545';
            warning.style.color = 'white';
            warning.style.padding = '10px 15px';
            warning.style.borderRadius = '8px';
            warning.style.zIndex = '1000';
            warning.style.fontSize = '14px';
            warning.style.fontWeight = 'bold';
            warning.style.boxShadow = '0 4px 12px rgba(220, 53, 69, 0.3)';
            warning.style.animation = 'slideIn 0.3s ease-out';
            warning.innerHTML = `
                ‚ö†Ô∏è Privacy Issue: ${privacyResult.type}
                <button onclick="clearDetection()" style="background: none; border: none; color: white; margin-left: 10px; cursor: pointer;">‚úï</button>
            `;

            document.body.appendChild(warning);
        }

        // Clear detection
        function clearDetection() {
            const testInput = document.getElementById('test-input');
            if (testInput.overlay) {
                testInput.overlay.remove();
                testInput.overlay = null;
            }

            const warning = document.getElementById('realtime-warning');
            if (warning) {
                warning.remove();
            }

            if (detectionTimeout) {
                clearTimeout(detectionTimeout);
                detectionTimeout = null;
            }

            currentPrivacyData = null;
            hideTooltip();
        }

        // Show tooltip
        function showTooltip(element, event) {
            const tooltip = document.getElementById('privacy-tooltip');
            const title = document.getElementById('tooltip-title');
            const severity = document.getElementById('tooltip-severity');
            const explanation = document.getElementById('tooltip-explanation');
            const suggestion = document.getElementById('tooltip-suggestion');
            const suggestionText = document.getElementById('tooltip-suggestion-text');
            const applyBtn = document.getElementById('tooltip-apply-btn');

            // Get privacy data
            const privacyData = {
                type: element.dataset.privacyType,
                severity: element.dataset.privacySeverity,
                explanation: element.dataset.privacyExplanation,
                suggestion: element.dataset.privacySuggestion,
                affected_text: element.textContent
            };

            // Update tooltip content
            title.textContent = privacyData.type || 'Privacy Issue';
            explanation.textContent = privacyData.explanation || 'This text contains potentially sensitive information.';
            
            severity.textContent = privacyData.severity || 'medium';
            severity.className = `tooltip-severity ${privacyData.severity || 'medium'}`;

            if (privacyData.suggestion) {
                suggestion.style.display = 'block';
                suggestionText.textContent = privacyData.suggestion;
                applyBtn.style.display = 'inline-block';
                applyBtn.dataset.originalText = element.textContent;
                applyBtn.dataset.suggestionText = privacyData.suggestion;
            } else {
                suggestion.style.display = 'none';
                applyBtn.style.display = 'none';
            }

            // Position tooltip
            const rect = element.getBoundingClientRect();
            tooltip.style.left = `${rect.left + rect.width / 2}px`;
            tooltip.style.top = `${rect.top - 10}px`;

            tooltip.classList.add('show');
        }

        // Hide tooltip
        function hideTooltip() {
            const tooltip = document.getElementById('privacy-tooltip');
            tooltip.classList.remove('show');
        }

        // Apply suggestion
        function applySuggestion() {
            const applyBtn = document.getElementById('tooltip-apply-btn');
            const testInput = document.getElementById('test-input');
            const originalText = applyBtn.dataset.originalText;
            const suggestionText = applyBtn.dataset.suggestionText;
            
            const currentValue = testInput.value;
            const newValue = currentValue.replace(originalText, suggestionText);
            testInput.value = newValue;
            
            clearDetection();
            if (newValue.trim()) {
                handleRealTimeDetection(newValue);
            }
            
            showNotification('Privacy fix applied!');
            hideTooltip();
        }

        // Set example
        function setExample(text) {
            const testInput = document.getElementById('test-input');
            testInput.value = text;
            handleRealTimeDetection(text);
        }

        // Show notification
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Utility functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // Fallback pattern detection
        function detectPrivacyPatterns(text) {
            const patterns = [
                { 
                    pattern: /\b\d{3}-\d{2}-\d{4}\b/, 
                    type: 'Social Security Number',
                    severity: 'high',
                    suggestion: 'Use "XXX-XX-XXXX" instead',
                    explanation: 'Social Security Numbers are highly sensitive personal identifiers'
                },
                { 
                    pattern: /\b\d{4}[\s-]?\d{4}[\s-]?\d{4}[\s-]?\d{4}\b/, 
                    type: 'Credit Card Number',
                    severity: 'high',
                    suggestion: 'Use "****-****-****-****" instead',
                    explanation: 'Credit card numbers are sensitive financial information'
                },
                { 
                    pattern: /\b\(?\d{3}\)?[-\s]?\d{3}[-\s]?\d{4}\b/, 
                    type: 'Phone Number',
                    severity: 'medium',
                    suggestion: 'Use "(555) 123-4567" format',
                    explanation: 'Phone numbers can be used to identify individuals'
                },
                { 
                    pattern: /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/, 
                    type: 'Email Address',
                    severity: 'medium',
                    suggestion: 'Use "user@example.com" instead',
                    explanation: 'Email addresses can be used to identify individuals'
                }
            ];

            for (const { pattern, type, severity, suggestion, explanation } of patterns) {
                if (pattern.test(text)) {
                    const match = text.match(pattern);
                    return {
                        privacy_issue: true,
                        type,
                        severity,
                        suggestion,
                        explanation,
                        affected_text: match[0]
                    };
                }
            }

            return { privacy_issue: false };
        }
    </script>
</body>
</html> 